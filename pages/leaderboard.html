import React, { useEffect, useMemo, useState } from "react";
import { motion } from "framer-motion";

/**
 * Explore the Universe 2175 — High Scores Page
 * - Pure React + TailwindCSS (no external UI lib required)
 * - Client-side sorting, filtering, pagination, and searching
 * - Drop-in fetch adapter to wire up to your backend
 * - Accessible, mobile-first, production-ready structure
 *
 * HOW TO USE
 * 1) Ensure Tailwind is enabled in your app (or replace classes with your CSS).
 * 2) Import and render <HighScoresPage /> inside your router.
 * 3) Replace `fetchScores` with a real API call (notes below).
 *
 * BACKEND EXPECTED SHAPE (example)
 * GET /api/scores?mode=global&window=30d&page=1&pageSize=50&sort=score:desc
 * -> {
 *      data: [{ id, username, userId, avatarUrl, score, level, platform, createdAt }...],
 *      total: 12345,
 *      you: { id, rank, score, username, avatarUrl }
 *    }
 */

// -----------------------------
// Utilities & Mock Data
// -----------------------------

const ONE_DAY = 24 * 60 * 60 * 1000;
const now = Date.now();

// Generate lightweight mock data to preview the page without a backend
function makeMockScores(count = 250) {
  const names = [
    "NovaRider","QuasarQueen","StellarSmith","NebulaNate","IonIvy",
    "PhotonPhil","DarkMatterDan","PulsarPiper","GravityGus","VectorV" 
  ];
  const platforms = ["PC","Mac","Linux","PS","Xbox","Switch"];
  return Array.from({ length: count }, (_, i) => {
    const username = names[i % names.length] + (i % 7 === 0 ? "_X" : "");
    const jitterDays = Math.floor(Math.random() * 120); // ~4 months
    return {
      id: `mock-${i}`,
      username,
      userId: `user-${i}`,
      avatarUrl: `https://api.dicebear.com/8.x/identicon/svg?seed=${encodeURIComponent(username)}`,
      score: Math.floor(1000 + Math.random() * 999000),
      level: 1 + Math.floor(Math.random() * 60),
      platform: platforms[Math.floor(Math.random() * platforms.length)],
      createdAt: new Date(now - jitterDays * ONE_DAY - (Math.random() * ONE_DAY)).toISOString(),
    };
  });
}

// Replace this with your real API call
async function fetchScores({ mode, windowKey, page, pageSize, sort }) {
  // Simulate network fetch using mock data
  const all = makeMockScores(500);
  const filtered = filterByWindow(all, windowKey);
  const sorted = sortScores(filtered, sort);
  const total = sorted.length;
  const start = (page - 1) * pageSize;
  const data = sorted.slice(start, start + pageSize);

  // Example: find current user (hard-coded as user-7)
  const youUserId = "user-7";
  const dense = rankDense(sorted);
  const youIndex = dense.findIndex((s) => s.userId === youUserId);
  const you = youIndex >= 0 ? {
    id: dense[youIndex].id,
    rank: dense[youIndex].__rank,
    score: dense[youIndex].score,
    username: dense[youIndex].username,
    avatarUrl: dense[youIndex].avatarUrl,
  } : null;

  return { data, total, you };
}

function filterByWindow(list, windowKey) {
  const cutoff = {
    "today": now - ONE_DAY,
    "7d": now - 7 * ONE_DAY,
    "30d": now - 30 * ONE_DAY,
    "90d": now - 90 * ONE_DAY,
    "all": 0,
  }[windowKey] ?? 0;
  return list.filter((item) => new Date(item.createdAt).getTime() >= cutoff);
}

function sortScores(list, sort) {
  const [field, direction] = sort.split(":");
  const dir = direction === "asc" ? 1 : -1;
  return [...list].sort((a, b) => {
    if (a[field] === b[field]) return 0;
    return a[field] > b[field] ? dir : -dir;
  });
}

// Dense ranking: 100, 100, 99 -> ranks 1,1,2
function rankDense(list) {
  let rank = 0;
  let prevScore = Infinity;
  return list.map((item, idx) => {
    if (item.score < prevScore) {
      rank = rank + 1;
      prevScore = item.score;
    }
    return { ...item, __rank: rank };
  });
}

// -----------------------------
// Page Component
// -----------------------------

const WINDOWS = [
  { key: "today", label: "Today" },
  { key: "7d", label: "7 Days" },
  { key: "30d", label: "30 Days" },
  { key: "90d", label: "90 Days" },
  { key: "all", label: "All-Time" },
];

const MODES = [
  { key: "global", label: "Global" },
  { key: "friends", label: "Friends" },
  { key: "local", label: "Local" },
];

const PAGE_SIZES = [25, 50, 100];

export default function HighScoresPage() {
  const [mode, setMode] = useState("global");
  const [windowKey, setWindowKey] = useState("30d");
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(50);
  const [sort, setSort] = useState("score:desc");
  const [query, setQuery] = useState("");
  const [platform, setPlatform] = useState("all");

  const [rows, setRows] = useState([]);
  const [total, setTotal] = useState(0);
  const [you, setYou] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Fetch data when controls change
  useEffect(() => {
    let isCancelled = false;
    setLoading(true);
    setError(null);
    fetchScores({ mode, windowKey, page, pageSize, sort })
      .then((res) => {
        if (isCancelled) return;
        setRows(res.data);
        setTotal(res.total);
        setYou(res.you);
      })
      .catch((e) => !isCancelled && setError(e?.message || "Failed to load."))
      .finally(() => !isCancelled && setLoading(false));
    return () => { isCancelled = true; };
  }, [mode, windowKey, page, pageSize, sort]);

  // Client-side search + platform filter
  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    return rows.filter((r) => {
      const matchesQ = q ? r.username.toLowerCase().includes(q) : true;
      const matchesPlatform = platform === "all" ? true : r.platform === platform;
      return matchesQ && matchesPlatform;
    });
  }, [rows, query, platform]);

  // Header sort
  function toggleSort(field) {
    setPage(1);
    setSort((prev) => {
      const [f, dir] = prev.split(":");
      if (f === field) {
        return `${field}:${dir === "asc" ? "desc" : "asc"}`;
      }
      return `${field}:desc`;
    });
  }

  // Pagination helpers
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  const canPrev = page > 1;
  const canNext = page < totalPages;

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-950 via-slate-900 to-black text-slate-100">
      {/* Header */}
      <header className="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-slate-950/70 bg-slate-950/60 border-b border-slate-800">
        <div className="mx-auto max-w-7xl px-4 py-4 flex items-center gap-4">
          <div className="flex-1">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight">High Scores</h1>
            <p className="text-slate-400 text-sm">Explore the Universe 2175 — Global Leaderboards</p>
          </div>

          {/* Mode Tabs */}
          <nav className="hidden md:flex items-center gap-1 rounded-xl p-1 bg-slate-800/60 border border-slate-700">
            {MODES.map((m) => (
              <button
                key={m.key}
                onClick={() => { setMode(m.key); setPage(1); }}
                className={
                  "px-3 py-1.5 rounded-lg text-sm transition " +
                  (mode === m.key
                    ? "bg-slate-200 text-slate-900"
                    : "hover:bg-slate-700/70 text-slate-200")
                }
                aria-pressed={mode === m.key}
              >
                {m.label}
              </button>
            ))}
          </nav>
        </div>
      </header>

      {/* Controls */}
      <section className="mx-auto max-w-7xl px-4 pt-4 pb-2">
        <div className="flex flex-col lg:flex-row gap-3">
          <div className="flex items-center gap-2">
            {WINDOWS.map((w) => (
              <button
                key={w.key}
                onClick={() => { setWindowKey(w.key); setPage(1); }}
                className={
                  "px-3 py-1.5 rounded-full border transition text-sm " +
                  (windowKey === w.key
                    ? "bg-indigo-500 border-indigo-400 text-white"
                    : "border-slate-700 hover:bg-slate-800")
                }
                aria-pressed={windowKey === w.key}
              >
                {w.label}
              </button>
            ))}
          </div>

          <div className="flex-1"></div>

          <div className="flex items-center gap-2">
            <label className="sr-only" htmlFor="search">Search player</label>
            <input
              id="search"
              placeholder="Search player…"
              value={query}
              onChange={(e) => { setQuery(e.target.value); setPage(1); }}
              className="bg-slate-900/80 border border-slate-700 rounded-xl px-3 py-2 w-56 outline-none focus:ring-2 ring-indigo-400"
            />
            <select
              value={platform}
              onChange={(e) => { setPlatform(e.target.value); setPage(1); }}
              className="bg-slate-900/80 border border-slate-700 rounded-xl px-3 py-2"
              aria-label="Platform"
            >
              <option value="all">All Platforms</option>
              <option value="PC">PC</option>
              <option value="Mac">Mac</option>
              <option value="Linux">Linux</option>
              <option value="PS">PS</option>
              <option value="Xbox">Xbox</option>
              <option value="Switch">Switch</option>
            </select>
            <select
              value={pageSize}
              onChange={(e) => { setPageSize(Number(e.target.value)); setPage(1); }}
              className="bg-slate-900/80 border border-slate-700 rounded-xl px-3 py-2"
              aria-label="Rows per page"
            >
              {PAGE_SIZES.map((n) => (<option key={n} value={n}>{n}/page</option>))}
            </select>
          </div>
        </div>
      </section>

      {/* You Banner */}
      {you && (
        <section className="mx-auto max-w-7xl px-4 pb-2">
          <motion.div
            initial={{ opacity: 0, y: -4 }}
            animate={{ opacity: 1, y: 0 }}
            className="rounded-2xl border border-slate-800 bg-slate-900/70 px-4 py-3 flex items-center gap-4"
          >
            <img src={you.avatarUrl} alt="Your avatar" className="h-10 w-10 rounded-full" />
            <div className="text-sm">
              <div className="text-slate-300">You're currently ranked <span className="font-semibold text-white">#{you.rank}</span></div>
              <div className="text-slate-400">Score: <span className="font-mono">{you.score.toLocaleString()}</span></div>
            </div>
            <div className="flex-1" />
            <a href="/profile" className="px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-white text-sm font-medium">View Profile</a>
          </motion.div>
        </section>
      )}

      {/* Table */}
      <main className="mx-auto max-w-7xl px-4 py-3">
        <div className="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/60">
          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="bg-slate-900/70 text-slate-300">
                  <Th label="#" className="w-16 text-right" />
                  <Th label="Player" onClick={() => toggleSort("username")} active={sort.startsWith("username")} />
                  <Th label="Score" onClick={() => toggleSort("score")} active={sort.startsWith("score")} className="text-right" />
                  <Th label="Level" onClick={() => toggleSort("level")} active={sort.startsWith("level")} className="text-right" />
                  <Th label="Platform" onClick={() => toggleSort("platform")} active={sort.startsWith("platform")} />
                  <Th label="Date" onClick={() => toggleSort("createdAt")} active={sort.startsWith("createdAt")} />
                </tr>
              </thead>
              <tbody>
                {loading && (
                  <tr><td colSpan={6} className="p-8 text-center text-slate-400">Loading…</td></tr>
                )}
                {error && !loading && (
                  <tr><td colSpan={6} className="p-8 text-center text-rose-400">{String(error)}</td></tr>
                )}
                {!loading && !error && filtered.length === 0 && (
                  <tr><td colSpan={6} className="p-8 text-center text-slate-400">No scores found.</td></tr>
                )}
                {!loading && !error && filtered.map((row, idx) => (
                  <Row
                    key={row.id}
                    row={row}
                    rank={(page - 1) * pageSize + idx + 1}
                    highlight={you?.id === row.id}
                  />
                ))}
              </tbody>
            </table>
          </div>

          {/* Footer / Pagination */}
          <div className="flex flex-col sm:flex-row items-center gap-3 justify-between p-3 border-t border-slate-800">
            <div className="text-xs text-slate-400">
              Showing {(page - 1) * pageSize + 1}–{Math.min(page * pageSize, total)} of {total.toLocaleString()} entries
            </div>
            <div className="flex items-center gap-2">
              <button
                disabled={!canPrev}
                onClick={() => setPage((p) => Math.max(1, p - 1))}
                className={btnPager(!canPrev)}
                aria-label="Previous page"
              >
                ‹ Prev
              </button>
              <span className="text-xs text-slate-400">Page {page} / {totalPages}</span>
              <button
                disabled={!canNext}
                onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                className={btnPager(!canNext)}
                aria-label="Next page"
              >
                Next ›
              </button>
            </div>
          </div>
        </div>

        {/* CTA Section */}
        <section className="mt-6 grid gap-3 sm:grid-cols-2">
          <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950/60">
            <h3 className="text-lg font-semibold">How are scores calculated?</h3>
            <p className="text-slate-400 text-sm mt-1">
              Scores are based on mission difficulty, completion time, damage taken, collectibles, and streak multipliers.
              Anti-cheat protects the board: submissions are signed and validated server-side.
            </p>
          </div>
          <div className="rounded-2xl border border-slate-800 p-4 bg-slate-950/60">
            <h3 className="text-lg font-semibold">Submit your score</h3>
            <p className="text-slate-400 text-sm mt-1">Finish a run in-game to auto-submit, or use the developer API for test profiles.</p>
            <div className="mt-3 flex gap-2">
              <a href="/download" className="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-white text-sm font-medium">Get the Game</a>
              <a href="/docs/api#scores" className="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-100 text-sm font-medium border border-slate-700">API Docs</a>
            </div>
          </div>
        </section>
      </main>

      {/* Footer */}
      <footer className="mx-auto max-w-7xl px-4 py-10 text-center text-xs text-slate-500">
        © {new Date().getFullYear()} Explore the Universe 2175
      </footer>
    </div>
  );
}

// -----------------------------
// Presentational Subcomponents
// -----------------------------

function Th({ label, onClick, active, className = "" }) {
  const clickable = Boolean(onClick);
  return (
    <th
      scope="col"
      className={
        "text-left font-semibold px-4 py-3 select-none " +
        (clickable ? "cursor-pointer hover:text-white " : "") +
        (active ? "text-white " : "") + className
      }
      onClick={onClick}
    >
      <div className="inline-flex items-center gap-1">
        <span>{label}</span>
        {clickable && (
          <svg aria-hidden="true" viewBox="0 0 16 16" className="h-3 w-3 opacity-70">
            <path fill="currentColor" d="M4 6l4-4 4 4zM4 10l4 4 4-4z" />
          </svg>
        )}
      </div>
    </th>
  );
}

function Row({ row, rank, highlight }) {
  return (
    <tr className={
      "border-t border-slate-800/80 " +
      (highlight ? "bg-indigo-950/40" : "hover:bg-slate-900/40")
    }>
      <td className="px-4 py-3 text-right font-mono text-slate-300">#{rank}</td>
      <td className="px-4 py-3">
        <div className="flex items-center gap-3">
          <img src={row.avatarUrl} alt="avatar" className="h-8 w-8 rounded-full"/>
          <div className="leading-tight">
            <div className="font-medium text-slate-100">{row.username}</div>
            <div className="text-xs text-slate-400">ID: {row.userId}</div>
          </div>
        </div>
      </td>
      <td className="px-4 py-3 text-right font-mono">{row.score.toLocaleString()}</td>
      <td className="px-4 py-3 text-right">{row.level}</td>
      <td className="px-4 py-3">{row.platform}</td>
      <td className="px-4 py-3 text-slate-300">{new Date(row.createdAt).toLocaleDateString()}</td>
    </tr>
  );
}

// -----------------------------
// Styling helpers
// -----------------------------

function btnPager(disabled) {
  return (
    "px-3 py-1.5 rounded-lg border text-sm " +
    (disabled
      ? "border-slate-800 text-slate-600 cursor-not-allowed"
      : "border-slate-700 hover:bg-slate-800 text-slate-100")
  );
}
